trigger:
- main

variables:
  AUTHSERVICE_MYSQL_MASTER_HOST: localhost
  AUTHSERVICE_MYSQL_REPLICA_HOST: localhost
  AUTHSERVICE_MYSQL_MASTER_PORT: 3306
  AUTHSERVICE_MYSQL_REPLICA_PORT: 3306
  MYSQL_USER: root
  MYSQL_PASS: imad

pool:
  vmImage: ubuntu-latest

steps:
- task: DockerCompose@0
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryEndpoint: 'DockerRegistry'
    dockerComposeFile: 'docker/docker-compose.yml'
    action: 'Run a Docker Compose command'
    dockerComposeCommand: 'up -d'
    
- task: Maven@3
  inputs:
    mavenPomFile: 'authservice/pom.xml'
    goals: 'clean install sonar:sonar'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    javaHomeOption: 'JDKVersion'
    mavenVersionOption: 'Default'
    mavenAuthenticateFeed: false
    effectivePomSkip: false
    sonarQubeRunAnalysis: true
    sqMavenPluginVersionChoice: 'latest'

- task: Docker@2
  inputs:
    containerRegistry: 'DockerRegistry'
    repository: 'imadelfetouh99/authservice'
    command: 'buildAndPush'
    Dockerfile: 'docker/Dockerfile'
    buildContext: 
    tags: 'latest'

- task: DockerCompose@0
  inputs:
    containerregistrytype: 'Azure Container Registry'
    azureSubscription: 'Azure for Students(a82fa0f1-3269-403a-a80f-e6891debc186)'
    azureContainerRegistry: '{"loginServer":"kwetterimad.azurecr.io", "id" : "/subscriptions/a82fa0f1-3269-403a-a80f-e6891debc186/resourceGroups/appsvc_windows_centralus/providers/Microsoft.ContainerRegistry/registries/kwetterimad"}'
    dockerComposeFile: 'docker/docker-production-compose.yml'
    projectName: 'imadelfetouh99/authservice'
    action: 'Push services'